(function(d){d.jgrid.odataHelper={resolveJsonReferences:function(a,d){function c(b,a,m){if("object"!==typeof b||!b)return b;if("[object Array]"===Object.prototype.toString.call(b)){for(e=0;e<b.length;e++){if("object"!==typeof b[e]||!b[e])return b[e];b[e]=b[e].$ref?c(b[e],e,b):c(b[e],a,b)}return b}if(b.$ref){f=b.$ref;if(l[f])return l[f];d.push([m,a,f])}else{if(b.$id){a=b.$id;delete b.$id;if(b.$values)b=b.$values.map(c);else for(var k in b)b.hasOwnProperty(k)&&(b[k]=c(b[k],k,b));l[a]=b}return b}}var e,
f,l={};d=d||[];"string"===typeof a&&(a=JSON.parse(a));a=c(a);for(e=0;e<d.length;e++)f=d[e],f[0][f[1]]=l[f[2]];return a},convertXmlToJson:function(a){var g={},c,e,f,l;if(!a)return null;if(1===a.nodeType){if(0<a.attributes.length)for(g["@attributes"]={},c=0;c<a.attributes.length;c++)e=a.attributes.item(c),g["@attributes"][e.nodeName]=e.nodeValue}else 3===a.nodeType?g=a.nodeValue:a.nodeType||(g=a);if(a.hasChildNodes&&a.hasChildNodes())for(c=0;c<a.childNodes.length;c++){e=a.childNodes.item(c);if(3===
e.nodeType)return e.nodeValue;f=e.nodeName;void 0===g[f]?g[f]=d.jgrid.odataHelper.convertXmlToJson(e):(void 0===g[f].push&&(l=g[f],g[f]=[],g[f].push(l)),g[f].push(d.jgrid.odataHelper.convertXmlToJson(e)))}return d.isEmptyObject(g)?null:g},parseMetadata:function(a,g){function c(l){var b={},a=[],c={};d("EntityContainer EntitySet",l).each(function(k,l){b[d(l).attr("EntityType")]=d(l).attr("Name");a.push(d(l).attr("Name"))});var k=d("Schema",l).attr("Namespace")+".";d("EntityType, ComplexType",l).each(function(){var h,
e,f,g,p,r,t,n;e=d(this).find("Property,NavigationProperty");g=(f=d("Key PropertyRef",this))&&0<f.length?f.first().attr("Name"):"";f=d(this).attr("Name");e&&(h=[],e.each(function(b,k){n={};d.each(k.attributes,function(){n[this.name]=this.value});p=n.Name===g;t="NavigationProperty"===k.tagName;r="Property"===k.tagName&&0<d('ComplexType[Name="'+n.Name+'"]',l).length;h.push(d.extend({iskey:p,isComplex:r,isNavigation:t,isCollection:0<=d.inArray(n.Name,a)},n))}),b[k+f]&&(c[b[k+f]]=h),c[f]=h)});return c}
function e(l){var b,a,c,k,h,e,f,g,p,r={},t={},n=[];for(h=0;h<l.EntityContainer.Elements.length;h++)t[l.EntityContainer.Elements[h].Type.ElementType.Definition.Name]=l.EntityContainer.Elements[h].Name,n.push(l.EntityContainer.Elements[h].Name);for(h=0;h<l.SchemaElements.length;h++)if(a=l.SchemaElements[h].DeclaredProperties,l.SchemaElements[h].NavigationProperties&&(a=a.concat(l.SchemaElements[h].NavigationProperties)),c=(b=l.SchemaElements[h].DeclaredKey)&&0<b.length?b[0].Name:"",p=l.SchemaElements[h].Name,
a){b=[];for(h=0;h<a.length;h++)k=a[h].Name===c,f=a[h].Type.IsNullable,g=a[h].Type.Definition.Namespace+a[h].Type.Definition.Name,e=!!a[h].Type.Definition.DeclaredProperties,b.push({Name:a[h].Name,Type:g,Nullable:f,iskey:k,isComplex:e,isNavigation:!1,isCollection:0<=d.inArray(a[h].Name,n)});t[p]&&(r[t[p]]=b);r[p]=b}return r}var f;switch(g){case "xml":f=c(a);break;case "json":f=e(a);break;case "datajs":f=void 0}return f},loadError:function(a,g,c){var e=a.status,f=c;if(!a.responseJSON)if(a.responseXML)a.responseText=
a.responseText.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g,"<$1$3>"),a.responseXML=d.parseXML(a.responseText),a.responseJSON=d.jgrid.odataHelper.convertXmlToJson(a.responseXML);else if(a.responseText)try{a.responseJSON=d.parseJSON(a.responseText)}catch(l){}if(a.responseJSON){if(a=a.responseJSON["@odata.error"]||a.responseJSON["odata.error"]||a.responseJSON.error)a.innererror?a.innererror.internalexception?(g=a.innererror.internalexception.message,f=a.innererror.internalexception.stacktrace||""):(g=a.innererror.message,
f=a.innererror.stacktrace||""):(g=a.message.value||a.message,f=a.stacktrace||"")}else c&&d.isPlainObject(c)&&(g=c.message,f=c.stack,e=c.code);return"<div>Status/error code: "+e+"</div><div>Message: "+g+'</div><div style="font-size: 0.8em;">'+f+"</div><br/>"}};d.jgrid.cmTemplate.odataComplexType={editable:!1,formatter:function(a,g,c){return d(this).jqGrid("odataJson",a,g,c)}};d.jgrid.cmTemplate.odataNavigationProperty={editable:!1,formatter:function(a,g,c){if(!g.colModel.odata.expand||"link"===g.colModel.odata.expand)return d(this).jqGrid("odataLink",
a,g,c);if("json"===g.colModel.odata.expand)return d(this).jqGrid("odataJson",a,g,c);if("subgrid"===g.colModel.odata.expand)return d(this).jqGrid("odataSubgrid",a,g,c)}};d.jgrid.cmTemplate["Edm.GeographyPoint"]={editable:!1,formatter:function(a,g,c){a||"xml"!==this.p.datatype||(a=d(c).filter(function(){return this.localName.toLowerCase()===g.colModel.name.toLowerCase()}),a=d.jgrid.odataHelper.convertXmlToJson(a[0]));return a.crs&&a.coordinates?d.jgrid.format("<div>{0}</div><div>[{1},{2}]</div>",a.crs.properties.name,
a.coordinates[0],a.coordinates[1]):d.jgrid.format("<div>{0}</div>",a)}};d.jgrid.extend({odataLink:function(a,g,c){var e=this[0].p;if("xml"!==e.datatype){if(c[g.colModel.name+"@odata.navigationLink"])return a=c[g.colModel.name+"@odata.navigationLink"],g=d.jgrid.format('<a href="{0}/{1}" target="_self">{2}</a>',e.odata.baseUrl,a,g.colModel.name);a=c[e.jsonReader.id]}else a=function(a){return d(c).filter(function(){return this.localName&&this.localName.toLowerCase()===a}).text()}(e.xmlReader.id.toLowerCase());
return g=e.odata.iscollection?d.jgrid.format('<a href="{0}({1})/{2}" target="_self">{2}</a>',e.url,a,g.colModel.name):d.jgrid.format('<a href="{0}/{1}" target="_self">{1}</a>',e.url,g.colModel.name)},odataJson:function(a,g,c){var e,f={};"xml"===this[0].p.datatype&&(a=d(c).filter(function(){return this.localName.toLowerCase()===g.colModel.name.toLowerCase()}),a=d.jgrid.odataHelper.convertXmlToJson(a[0]));for(e in a)a.hasOwnProperty(e)&&e&&0>e.indexOf("@odata.")&&0>e.indexOf("@attributes")&&(f[e]=a[e]);
return JSON.stringify(f,null,1)},odataSubgrid:function(a,g,c){var e,f=this[0].p;a="xml"!==f.datatype?c[f.jsonReader.id]:function(a){return d(c).filter(function(){return this.localName&&this.localName.toLowerCase()===a}).text()}(f.xmlReader.id.toLowerCase());for(e in f._index)if(f._index.hasOwnProperty(e)&&e&&a===f._index[e].toString()){a=e;break}return g=d.jgrid.format('<a style="cursor:pointer" data-id="{0}" onclick=\'$("#{2}").jqGrid("setGridParam", { odata: {activeEntitySet: "{1}" } });$("#{2}").jqGrid("expandSubGridRow", "{0}");return false;\'>{1}</a>',
a,g.colModel.name,g.gid)},parseColumns:function(a,g){for(var c=0,e,f,l,b,v,m=[],k,c=0;c<a.length;c++)e=0<="Edm.Int16,Edm.Int32,Edm.Int64".indexOf(a[c].Type),f=0<="Edm.Decimal,Edm.Double,Edm.Single".indexOf(a[c].Type),b=0<="Edm.Byte,Edm.SByte".indexOf(a[c].Type),l=a[c].Type&&0<=a[c].Type.indexOf("Edm.")&&(0<=a[c].Type.indexOf("Date")||0<=a[c].Type.indexOf("Time")),v=d.jgrid.cmTemplate[a[c].Type]?a[c].Type:a[c].isComplex?"odataComplexType":a[c].isNavigation?"odataNavigationProperty":e?"integerStr":
f?"numberStr":b?"booleanCheckbox":"text",k={integer:e,number:f,date:l,required:!a[c].Nullable||"false"===a[c].Nullable},e=e?"integer":f?"number":l?"datetime":b?"checkbox":"text",f=a[c].isNavigation||a[c].isComplex?'<span class="ui-icon ui-icon-arrowreturn-1-s" style="display:inline-block;vertical-align:middle;"></span>'+a[c].Name:a[c].Name,m.push(d.extend({label:f,name:a[c].Name,index:a[c].Name,editable:!a[c].isNavigation&&!a[c].iskey,searchrules:k,editrules:k,searchtype:e,inputtype:e,edittype:e,
key:a[c].iskey,odata:{expand:a[c].isNavigation?g:a[c].isComplex?"json":null,isnavigation:a[c].isNavigation,iscomplex:a[c].isComplex,iscollection:a[c].isCollection}},d.jgrid.cmTemplate[v]));return m},odataInit:function(a){function g(a,b,c,e){var k,h;if(b&&(c||"nu"===e||"nn"===e)){if(c)for(k=0;k<a.colModel.length;k++)if(h=a.colModel[k],h.name===b){if(h.odata.nosearch||h.odata.unformat&&(b=d.isFunction(h.odata.unformat)?h.odata.unformat(b,c,e):h.odata.unformat,!b))return;h.searchrules&&(h.searchrules.integer||
h.searchrules.number||h.searchrules.date)?h.searchrules&&h.searchrules.date&&(c=(new Date(c)).toISOString()):c="'"+c+"'";break}switch(e){case "in":case "cn":return"indexof("+b+",tolower("+c+")) gt -1";case "ni":case "nc":return"indexof("+b+",tolower("+c+")) eq -1";case "bw":return"startswith("+b+","+c+") eq true";case "bn":return"startswith("+b+","+c+") eq false";case "ew":return"endswith("+b+","+c+") eq true";case "en":return"endswith("+b+","+c+") eq false";case "nu":return b+" eq null";case "nn":return b+
" ne null";default:return b+" "+e+" "+c}}}function c(a,b){var d,e,k="";if(a.groups&&a.groups.length){for(d=0;d<a.groups.length;d++)k+="("+c(a.groups[d],b)+")",d<a.groups.length-1&&(k+=" "+a.groupOp.toLowerCase()+" ");a.rules&&a.rules.length&&(k+=" "+a.groupOp.toLowerCase()+" ")}if(a.rules.length)for(d=0;d<a.rules.length;d++)e=a.rules[d],(e=g(b,e.field,e.data,e.op))&&(k+=e+" "+a.groupOp.toLowerCase()+" ");return k=k.trim().replace(/\s(and|or)$/,"").trim()}function e(a,b,c,e){var k=a.colModel.filter(function(b){return b.name===
a.odata.activeEntitySet})[0];e=a._index[e];e=a.odata.iscollection?d.jgrid.format("{0}({1})/{2}",a.url,e,a.odata.activeEntitySet):d.jgrid.format("{0}/{1}",a.url,a.odata.activeEntitySet);var h={datatype:b.datatype,version:b.version,gencolumns:!1,expandable:b.expandable,odataurl:e,errorfunc:b.errorfunc,annotations:b.annotations,entitySet:a.odata.activeEntitySet};d("#"+c).html('<table id="'+c+'_t" class="scroll"></table>');d("#"+c+"_t").jqGrid({colModel:a.odata.subgridCols[a.odata.activeEntitySet],odata:d.extend({},
a.odata,k.odata),loadonce:!0,beforeInitGrid:function(){d(this).jqGrid("odataInit",h)},loadError:function(a,b,k){a=d.jgrid.odataHelper.loadError(a,b,k);a=d("#errdialog").html()+a;d("#errdialog").html(a).dialog("open")}})}function f(a,b){var f;f={datatype:b.datatype,jsonpCallback:b.callback};var m=function(k,c){return e(a,b,k,c)};a.odata||(a.odata={iscollection:!0});d.extend(a,{serializeGridData:function(k){var h=k;k={};a.odata.iscollection?(k={$top:h.rows,$skip:(parseInt(h.page,10)-1)*a.rowNum},"jsonp"===
b.datatype&&(k.$callback=b.callback),!b.version||4>b.version?(k.$inlinecount="allpages",k.$format="xml"===b.datatype?"atom":"application/json;odata=fullmetadata"):(k.$count=!0,k.$format="xml"===b.datatype?"atom":"application/json;odata.metadata=full"),h.sidx&&(k.$orderby=h.sidx+" "+h.sord),h._search&&(h.filters?(h=d.parseJSON(h.filters),h=c(h,a),0<h.length&&(k.$filter=h)):k.$filter=g(a,h.searchField,h.searchString,h.searchOper))):k.$format=!b.version||4>b.version?"xml"===b.datatype?"atom":"application/json;odata=fullmetadata":
"xml"===b.datatype?"atom":"application/json;odata.metadata=full";return this.p.odata.postData=k},ajaxGridOptions:f,mtype:"GET",url:b.odataurl},f);b.gencolumns&&!b.async&&(a.loadonce=!1);if(a.colModel)for(f=0;f<a.colModel.length;f++)if(a.colModel[f].odata&&"subgrid"===a.colModel[f].odata.expand){a.subGrid=!0;a.subGridRowExpanded=m;a.odata.activeEntitySet=a.colModel[f].name;a.loadonce=!0;break}m={contentType:"application/"+("jsonp"===b.datatype?"json":b.datatype)+";charset=utf-8",datatype:"jsonp"===
b.datatype?"json":b.datatype};a.inlineEditing=d.extend(!0,{beforeSaveRow:function(a,c){"edit"===a.extraparam.oper?(a.url=b.odataurl,a.mtype=b.odataverbs.inlineEditingEdit,a.url+="("+c+")"):(a.url=b.odataurl,a.mtype=b.odataverbs.inlineEditingAdd);return!0},serializeSaveData:function(a){return JSON.stringify(a)},ajaxSaveOptions:m},a.inlineEditing||{});d.extend(a.formEditing,{onclickSubmit:function(k,c,d){"add"===d?(k.url=b.odataurl,k.mtype=b.odataverbs.formEditingAdd):"edit"===d&&(k.url=b.odataurl+
"("+c[a.id+"_id"]+")",k.mtype=b.odataverbs.formEditingEdit);return c},ajaxEditOptions:m,serializeEditData:function(a){return JSON.stringify(a)}});d.extend(a.formDeleting,{url:b.odataurl,mtype:"DELETE",serializeDelData:function(){return""},onclickSubmit:function(a,b){a.url+="("+b+")";return""},ajaxDelOptions:m});m=(m=a.colModel.filter(function(a){return!!a.key})[0])?m.name:a.sortname||"id";"xml"===b.datatype?(b.annotations&&d.extend(!0,a,{loadBeforeSend:function(a){a.setRequestHeader("Prefer",'odata.include-annotations="*"')}}),
d.extend(!0,a,{xmlReader:{root:function(b){b=b.childNodes[0];b.innerHTML=b.innerHTML.replace(/<(\/?)([^:>\s]*:)?([^>]+)>/g,"<$1$3>");var c=d(b).attr("m:context");c&&(a.odata.baseUrl=c.substring(0,c.indexOf("/$metadata")),a.odata.entityType=c.substring(c.indexOf("#")+1).replace("/$entity",""));if(c=d(b).attr("m:type"))a.odata.entityType=c.replace("#","");return b},row:function(a){return a="entry"===a.localName?[a]:d(">entry",a)},cell:function(a){return d(">content>properties",a).get(0).childNodes},
records:function(a){return d(">feed>entry",a).length},page:function(){return Math.ceil((a.odata.postData.$skip+a.rowNum)/a.rowNum)},total:function(b){b=d(">feed>entry",b).length;return Math.ceil((a.odata.postData.$skip+a.rowNum)/a.rowNum)+(0<b?1:0)},repeatitems:!0,userdata:"userdata",id:m}})):(d.extend(!0,a,{jsonReader:{root:function(b){var c=b["@odata.context"];c&&(a.odata.baseUrl=c.substring(0,c.indexOf("/$metadata")),a.odata.entityType=c.substring(c.indexOf("#")+1).replace("/$entity",""));if(c=
b["@odata.type"])a.odata.entityType=c.replace("#","");return b.value||[b]},repeatitems:!0,id:m}}),b.annotations?d.extend(!0,a,{loadBeforeSend:function(a){a.setRequestHeader("Prefer",'odata.include-annotations="*"')},jsonReader:{records:function(a){return a[b.annotationName].records},page:function(a){return a[b.annotationName].page},total:function(a){return a[b.annotationName].total},userdata:function(a){return a[b.annotationName].userdata}}}):d.extend(!0,a,{jsonReader:{records:function(a){return a["odata.count"]||
a["@odata.count"]},page:function(b){var c;b["odata.nextLink"]?c=parseInt(b["odata.nextLink"].split("skip=")[1],10):(c=a.odata.postData.$skip+a.rowNum,b=b["odata.count"]||b["@odata.count"],c>b&&(c=b));return Math.ceil(c/a.rowNum)},total:function(b){return Math.ceil((b["odata.count"]||b["@odata.count"])/a.rowNum)},userdata:"userdata"}}))}return this.each(function(){var c=this,b=d(c),e=c.p;if(c.grid&&e){var g=d.extend(!0,{gencolumns:!1,odataurl:e.url,datatype:"json",entitySet:null,annotations:!1,annotationName:"@jqgrid.GridModelAnnotate",
odataverbs:{inlineEditingAdd:"POST",inlineEditingEdit:"PATCH",formEditingAdd:"POST",formEditingEdit:"PUT"}},a||{});"jsonp"===g.datatype&&(g.callback="jsonpCallback");if(g.entitySet){if(g.gencolumns){var k=d.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,async:!1,entitySet:null,metadatatype:a.datatype||"xml",metadataurl:(a.odataurl||e.url)+"/$metadata"},a||{});k.async&&(k.successfunc=function(){c.grid.hDiv&&(c.grid.hDiv.loading=!1);b.trigger("reloadGrid")},c.grid.hDiv&&
(c.grid.hDiv.loading=!0));b.jqGrid("odataGenColModel",k)}f(e,g)}else d.isFunction(g.errorfunc)&&g.errorfunc({},"entitySet cannot be empty",0)}})},odataGenColModel:function(a){var g=this[0],c=g.p,e=d(g),f,l,b=d.extend(!0,{parsecolfunc:null,parsemetadatafunc:null,successfunc:null,errorfunc:null,entitySet:null,metadataurl:c.url+"/$metadata",metadatatype:"xml",expandable:"link",async:!1},a||{});"jsonp"===b.metadatatype&&(b.callback="jsonpCallback");if(b.entitySet)return d.ajax({url:b.metadataurl,type:"GET",
dataType:b.metadatatype,jsonpCallback:b.callback,async:b.async,cache:!1}).done(function(a,g,k){var h=0,u=0,q=0;if("json"===b.metadatatype||"jsonp"===b.metadatatype)a=d.jgrid.odataHelper.resolveJsonReferences(a);f=e.triggerHandler("jqGridODataParseMetadata",a);!f&&d.isFunction(b.parsemetadatafunc)&&(f=b.parsemetadatafunc(a,g,k));if(f)l=f;else if(f=d.jgrid.odataHelper.parseMetadata(a,b.metadatatype))if(l=e.triggerHandler("jqGridODataParseColumns",[b,f]),!l&&d.isFunction(b.parsecolfunc)&&(l=b.parsecolfunc(b,
f)),!l)for(h in l={},f)f.hasOwnProperty(h)&&h&&(l[h]=e.jqGrid("parseColumns",f[h],b.expandable));if(l){for(q in l)if(l.hasOwnProperty(q)&&q)for(h=0;h<c.colModel.length;h++)for(u=0;u<l[q].length;u++)if(l[q][u].name===c.colModel[h].name){d.extend(!0,l[q][u],c.colModel[h]);break}c.colModel=l[b.entitySet];c.colModel||d.isFunction(b.errorfunc)&&b.errorfunc({data:a,status:g,xhr:k},"EntitySet "+b.entitySet+" is not found");c.odata||(c.odata={iscollection:!0});c.odata.subgridCols=l;d.isFunction(b.successfunc)&&
b.successfunc()}else d.isFunction(b.errorfunc)&&b.errorfunc({data:a,status:g,xhr:k},"parse $metadata error")}).fail(function(a,c,e){if(d.isFunction(b.errorfunc)){var f=d.jgrid.odataHelper.loadError(a,c,e);b.errorfunc({xhr:a,error:c,code:e},f)}}),l;d.isFunction(b.errorfunc)&&b.errorfunc({},"entitySet cannot be empty",0)}})})(jQuery);
